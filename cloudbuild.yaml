timeout: 120s

options:
  dynamic_substitutions: true
  substitution_option: 'ALLOW_LOOSE'
substitutions:
  _REGION: 'europe-docker.pkg.dev'
  _ARTIFACT_REPO: 'gs://prod-rest_cloudbuild/hello-world'

steps:
  # собственно собираем джарник
  - name: 'maven:3.8.4-eclipse-temurin-17-alpine'
    entrypoint: 'mvn'
    args: [ 'package', '-Dmaven.test.skip=true' ]
    dir: 'helloworld'
  # пулим старый контейнер, если он есть
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker pull ${_REGION}/$PROJECT_ID/rest-api/$REPO_NAME:latest || exit 0']
  # билдим контейнер используя кэш спуленного ранее контейнера,
  # на основе указанного докерфайла
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build',
            '-t', '${_REGION}/${PROJECT_ID}/rest-api/$REPO_NAME:$SHORT_SHA',
            '-t', '${_REGION}/${PROJECT_ID}/rest-api/$REPO_NAME:latest',
            '--cache-from', '${_REGION}/${PROJECT_ID}/rest-api/$REPO_NAME:latest',
            '-f', 'Dockerfile',
            '.' ]
artifacts:
  objects:
    location: '${_ARTIFACT_REPO}'
    paths: ['./helloworld/target/h*.jar']

images:
  - '${_REGION}/${PROJECT_ID}/rest-api/$REPO_NAME:$SHORT_SHA'
  - '${_REGION}/${PROJECT_ID}/rest-api/$REPO_NAME:latest'




# example 2
#  - name: "alpine"
#    args: ['echo', '$_TEST_ENV']
#substitutions:
#  _TEST_ENV: Hello World from Alpine STEP in Google Cloud Build.


